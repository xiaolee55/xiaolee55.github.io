<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>生成器和promise | XiaoLeeBlog</title>
    <meta name="description" content="我的文章网站">
    <link rel="icon" href="/titlelogo.png">
    
    <link rel="preload" href="/assets/css/0.styles.ec507139.css" as="style"><link rel="preload" href="/assets/js/app.8d8834a2.js" as="script"><link rel="preload" href="/assets/js/2.4111b689.js" as="script"><link rel="preload" href="/assets/js/11.06b0a1b9.js" as="script"><link rel="prefetch" href="/assets/js/10.f5b7094d.js"><link rel="prefetch" href="/assets/js/12.a29a4b4d.js"><link rel="prefetch" href="/assets/js/13.85dd6f14.js"><link rel="prefetch" href="/assets/js/14.e058b9f1.js"><link rel="prefetch" href="/assets/js/15.fa0a1b7f.js"><link rel="prefetch" href="/assets/js/16.c674646e.js"><link rel="prefetch" href="/assets/js/3.f0f9c942.js"><link rel="prefetch" href="/assets/js/4.9eed5240.js"><link rel="prefetch" href="/assets/js/5.d37db87a.js"><link rel="prefetch" href="/assets/js/6.64a418b3.js"><link rel="prefetch" href="/assets/js/7.331065bf.js"><link rel="prefetch" href="/assets/js/8.a14ac5eb.js"><link rel="prefetch" href="/assets/js/9.7e7c1c97.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ec507139.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/fe.png" alt="XiaoLeeBlog" class="logo"> <span class="site-name can-hide">XiaoLeeBlog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文章" class="dropdown-title"><span class="title">文章</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/Javascript/JS中的作用域与闭包.html" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/pages/HTML与CSS/BFC的理解与运用.html" class="nav-link">HTML与CSS</a></li></ul></div></div><div class="nav-item"><a href="/pages/folder1/test3.html" class="nav-link">我的项目</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="读书笔记" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/读书笔记/图解HTTP/http方法.html" class="nav-link">图解HTTP</a></li><li class="dropdown-item"><!----> <a href="/pages/读书笔记/图解HTTP/http方法.html" class="nav-link">JS忍者秘籍</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/xiaolee55" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文章" class="dropdown-title"><span class="title">文章</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/Javascript/JS中的作用域与闭包.html" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/pages/HTML与CSS/BFC的理解与运用.html" class="nav-link">HTML与CSS</a></li></ul></div></div><div class="nav-item"><a href="/pages/folder1/test3.html" class="nav-link">我的项目</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="读书笔记" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/读书笔记/图解HTTP/http方法.html" class="nav-link">图解HTTP</a></li><li class="dropdown-item"><!----> <a href="/pages/读书笔记/图解HTTP/http方法.html" class="nav-link">JS忍者秘籍</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/xiaolee55" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JavaScript基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/Javascript/JS中的作用域与闭包.html" class="sidebar-link">JS中的作用域与闭包</a></li><li><a href="/pages/Javascript/JS中的值传递.html" class="sidebar-link">JS中的值传递</a></li><li><a href="/pages/Javascript/JS中的事件循环.html" class="sidebar-link">JS中的事件循环</a></li><li><a href="/pages/Javascript/JS中的对象访问控制.html" class="sidebar-link">JS中的对象访问控制</a></li><li><a href="/pages/Javascript/JS中的类型判断.html" class="sidebar-link">JS中的类型判断</a></li><li><a href="/pages/Javascript/JS中的生成器和Promise.html" class="active sidebar-link">JS中的生成器和Promise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/Javascript/JS中的生成器和Promise.html#生成器函数" class="sidebar-link">生成器函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/Javascript/JS中的生成器和Promise.html#什么是生成器函数" class="sidebar-link">什么是生成器函数</a></li><li class="sidebar-sub-header"><a href="/pages/Javascript/JS中的生成器和Promise.html#生成器函数的基本格式" class="sidebar-link">生成器函数的基本格式</a></li><li class="sidebar-sub-header"><a href="/pages/Javascript/JS中的生成器和Promise.html#生成器函数的运行原理和工作流程" class="sidebar-link">生成器函数的运行原理和工作流程</a></li><li class="sidebar-sub-header"><a href="/pages/Javascript/JS中的生成器和Promise.html#yield-操作符" class="sidebar-link">yield* 操作符</a></li><li class="sidebar-sub-header"><a href="/pages/Javascript/JS中的生成器和Promise.html#生成器函数的传参交互细节" class="sidebar-link">生成器函数的传参交互细节</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/Javascript/JS中的生成器和Promise.html#promise" class="sidebar-link">Promise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/Javascript/JS中的生成器和Promise.html#什么是promise" class="sidebar-link">什么是Promise</a></li><li class="sidebar-sub-header"><a href="/pages/Javascript/JS中的生成器和Promise.html#为什么需要异步代码" class="sidebar-link">为什么需要异步代码</a></li><li class="sidebar-sub-header"><a href="/pages/Javascript/JS中的生成器和Promise.html#为什么需要promise" class="sidebar-link">为什么需要Promise</a></li><li class="sidebar-sub-header"><a href="/pages/Javascript/JS中的生成器和Promise.html#promise的基本格式" class="sidebar-link">Promise的基本格式</a></li><li class="sidebar-sub-header"><a href="/pages/Javascript/JS中的生成器和Promise.html#promise的链式调用" class="sidebar-link">Promise的链式调用</a></li><li class="sidebar-sub-header"><a href="/pages/Javascript/JS中的生成器和Promise.html#promise-race" class="sidebar-link">Promise.race</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/Javascript/JS中的生成器和Promise.html#生成器与promise的结合（完全同步的方式来写异步代码）" class="sidebar-link">生成器与Promise的结合（完全同步的方式来写异步代码）</a></li><li class="sidebar-sub-header"><a href="/pages/Javascript/JS中的生成器和Promise.html#async和await" class="sidebar-link">async和await</a></li><li class="sidebar-sub-header"><a href="/pages/Javascript/JS中的生成器和Promise.html#参考书籍" class="sidebar-link">参考书籍</a></li></ul></li><li><a href="/pages/Javascript/掘金小册《前端性能优化原理与实践》阅读总结.html" class="sidebar-link">掘金小册《前端性能优化原理与实践》阅读总结.md</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="生成器和promise"><a href="#生成器和promise" class="header-anchor">#</a> 生成器和promise</h1> <h2 id="生成器函数"><a href="#生成器函数" class="header-anchor">#</a> 生成器函数</h2> <h3 id="什么是生成器函数"><a href="#什么是生成器函数" class="header-anchor">#</a> 什么是生成器函数</h3> <p>生成器是一种特殊类型的函数。当从头到尾运行标准函数时，它最多只生成一个值。
然而生成器函数会在几次运行请求中暂停，因此每次运行都可能会生成一个值。</p> <h3 id="生成器函数的基本格式"><a href="#生成器函数的基本格式" class="header-anchor">#</a> 生成器函数的基本格式</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">WeaponGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>　
    <span class="token keyword">yield</span> <span class="token string">&quot;Katana&quot;</span><span class="token punctuation">;</span> 　
    <span class="token keyword">yield</span> <span class="token string">&quot;Wakizashi&quot;</span><span class="token punctuation">;</span> 　
    <span class="token keyword">yield</span> <span class="token string">&quot;Kusarigama&quot;</span><span class="token punctuation">;</span>　　
<span class="token punctuation">}</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> weapon <span class="token keyword">of</span> <span class="token function">WeaponGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 　
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>weapon<span class="token punctuation">)</span>   <span class="token comment">//输出&quot;Katana&quot;，&quot;Wakizashi&quot;， &quot;Kusarigama&quot;</span>
<span class="token punctuation">}</span>　
</code></pre></div><h3 id="生成器函数的运行原理和工作流程"><a href="#生成器函数的运行原理和工作流程" class="header-anchor">#</a> 生成器函数的运行原理和工作流程</h3> <ul><li><strong>执行原理</strong></li></ul> <p>定义一个生成器（即调用生成器函数）的时候，会返回一个由多个yield组成的迭代器，调用next方法即可不断执行每个yield操作符后面及其
所在语句与上一个yield中间的语句（第一个yield是与函数头之间的语句），例子可看下面的交互细节处。</p> <ul><li><strong>调用流程</strong></li></ul> <ol><li>挂起开始——创建了一个生成器后，它最先以这种状态开始。其中的任何代码都未执行。</li> <li>执行——生成器中的代码执行的状态。执行要么是刚开始，要么是从上次挂起的时候继续的。当生成器对应的迭代器调用了next方法，并且当前存在可执行的代码时，生成器都会转移到这个状态。</li> <li>挂起让渡——当生成器在执行过程中遇到了一个yield表达式，它会创建一个包含着返回值的新对象，随后再挂起执行。生成器在这个状态暂停并等待继续执行。</li> <li>完成——在生成器执行期间，如果代码执行到return语句或者全部代码执行完毕，生成器就进入该状态。</li></ol> <ul><li><strong>与标准函数的差异</strong></li></ul> <ol><li>标准函数仅仅会被重复调用，每次调用都会创建一个新的执行环境上下文。相比之下，生成器的执行环境上下文则会暂时挂起并在将来恢复。
并从上次挂起的地方开始执行。</li> <li>因为我们一直持有对生成器的引用，所以其作用域并不会销毁，知道进入完成状态，也就是说生成器的执行环境上下文一直是保存的
。而不是像标准函数一样退出后销毁。（类似闭包）只要我们能保证函数还存在，环境及变量就都存在着。保证只要迭代器还需要它的时候它都存在。</li></ol> <h3 id="yield-操作符"><a href="#yield-操作符" class="header-anchor">#</a> yield* 操作符</h3> <blockquote><p>作用是符将执行权交给另一个生成器，即嵌套生成器</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">WarriorGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 　
    <span class="token keyword">yield</span> <span class="token string">&quot;Sun Tzu&quot;</span><span class="token punctuation">;</span> 　
    <span class="token keyword">yield</span><span class="token operator">*</span> <span class="token function">NinjaGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>　<span class="token comment">//yield*将执行权交给了另一个生成器 　</span>
    <span class="token keyword">yield</span> <span class="token string">&quot;Genghis Khan&quot;</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">NinjaGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 　
    <span class="token keyword">yield</span> <span class="token string">&quot;Hattori&quot;</span><span class="token punctuation">;</span> 　
    <span class="token keyword">yield</span> <span class="token string">&quot;Yoshi&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> warrior <span class="token keyword">of</span> <span class="token function">WarriorGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 　
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>warrior<span class="token punctuation">)</span>    <span class="token comment">//输出Sun Tzu、Hattori、Yoshi、Genghis Khan。 </span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="生成器函数的传参交互细节"><a href="#生成器函数的传参交互细节" class="header-anchor">#</a> 生成器函数的传参交互细节</h3> <blockquote><p>生成器函数传参时，第一个yield用的参数是生成器产生时的值，后面的参数则是next函数传入的值
yield后面的语句的值为next函数的返回值value，yield前面的变量接收的值为下个next函数传过来的参数值</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token operator">*</span> <span class="token function">Gen</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;val1&quot;</span><span class="token punctuation">,</span>val<span class="token punctuation">)</span>
  val <span class="token operator">=</span><span class="token keyword">yield</span> val<span class="token operator">*</span><span class="token number">2</span>  
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'val2'</span><span class="token punctuation">,</span>val<span class="token punctuation">)</span>
  <span class="token keyword">yield</span> val
<span class="token punctuation">}</span>

<span class="token keyword">let</span> gen <span class="token operator">=</span> <span class="token function">Gen</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>  <span class="token comment">//输出4 ，也就是说这个3没有任何作用，因为他是迭代器的第一项，使用的值是生成器生成时的参数</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>  <span class="token comment">//输出5</span>
</code></pre></div><h2 id="promise"><a href="#promise" class="header-anchor">#</a> Promise</h2> <h3 id="什么是promise"><a href="#什么是promise" class="header-anchor">#</a> 什么是Promise</h3> <p>简单来说是对异步代码的一种解决方案。promise对象是对我们现在尚未得到但将来会得到值的占位符；
它是对我们最终能够得知异步计算结果的一种保证。如果我们兑现了我们的承诺，那结果会得到一个值。
如果发生了问题，结果则是一个错误， 一个为什么不能交付的原因。</p> <h3 id="为什么需要异步代码"><a href="#为什么需要异步代码" class="header-anchor">#</a> 为什么需要异步代码</h3> <p>使用异步代码的原因在于不希望在执行长时间任务的时候，应用程序的执行被阻塞（影响用户体验）。
当前，通过使用回调函数解决这个问题：对长时间执行的任务提供一个函数，当任务结束后会调用该回调函数。</p> <h3 id="为什么需要promise"><a href="#为什么需要promise" class="header-anchor">#</a> 为什么需要Promise</h3> <blockquote><p>为了解决形如以下的回调地狱问题，用链式方式写异步代码</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        url<span class="token punctuation">:</span> <span class="token string">'xxx.com'</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token string">'jsonp'</span><span class="token punctuation">,</span>
        <span class="token function-variable function">success</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">init</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">render</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 一层一层又一层</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>为了解决异常不能被正确捕获的问题，如下</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span> 　
    <span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token string">&quot;data/ninjas.json&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 　　 
    <span class="token comment">//Handle results 　</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
 <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/*Handle errors*/</span><span class="token punctuation">}</span>
导致这个问题的原因在于，当长时间任务开始运行，调用回调函数的代码一般不会和开始任务中的这段代码位于事件循环的同一步骤，
要通过参数的方式解决：
<span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token string">&quot;data/ninjas.json&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> ninjas</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 　
 <span class="token function">getJSON</span><span class="token punctuation">(</span>ninjas<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>location<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> locationInfo</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 　　
     <span class="token function">　sendOrder</span><span class="token punctuation">(</span>locationInfo<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> status</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 　　 <span class="token comment">/*Process status*/</span> 　　<span class="token punctuation">}</span><span class="token punctuation">)</span> 　
      <span class="token punctuation">}</span><span class="token punctuation">)</span> 
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="promise的基本格式"><a href="#promise的基本格式" class="header-anchor">#</a> Promise的基本格式</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ... some code</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token comment">/* 异步操作成功 */</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
其中resolve和reject分别对应执行成功和失败的回调函数
</code></pre></div><h3 id="promise的链式调用"><a href="#promise的链式调用" class="header-anchor">#</a> Promise的链式调用</h3> <blockquote><p>不管Promise中的resolve是否立刻执行，then中的代码一定是异步的，也就是说即使Promise对象中的代码是同步执行的，then也是异步的.每次then的执行结果也是一个Promise对象，所以可以将回调函数中的嵌套代码转为以下的链式</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">fulfill<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">fulfill</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
example<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> value<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token comment">//输出1</span>
       <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//输出2，使用了上个Promise的返回值</span>

<span class="token comment">//可以像这样在then内直接写成功和失败的回调函数</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  

 <span class="token comment">//也可以以这种形式写对应处理</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="promise-race"><a href="#promise-race" class="header-anchor">#</a> Promise.race</h3> <blockquote><p>并行请求的对应优雅写法，同时发多个请求，resolve最早返回的结果</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'data1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'data2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'data3'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">person</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;第一个返回的是&quot;</span><span class="token operator">+</span>person<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;出错了&quot;</span><span class="token operator">+</span>error<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="生成器与promise的结合（完全同步的方式来写异步代码）"><a href="#生成器与promise的结合（完全同步的方式来写异步代码）" class="header-anchor">#</a> 生成器与Promise的结合（完全同步的方式来写异步代码）</h2> <blockquote><p>最终结果结合了同步代码和异步代码的优点。有了同步代码，我们能更容易地理解、使用标准控制流以及异常处理机制、
try-catch语句的能力。而对于异步代码来说，我们有着天生的非阻塞：当等待长时间运行的异步任务时，应用的执行不会被阻塞</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>　　<span class="token comment">//返回异步结果的函数在等待异步结果返回时应当能够暂停 ，注意function*，我们在使用生成器 　</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span> 　　
    <span class="token keyword">const</span> ninjas <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getJSON</span><span class="token punctuation">(</span><span class="token string">&quot;data/ninjas.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 　　
    <span class="token keyword">const</span> missions <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getJSON</span><span class="token punctuation">(</span>ninjas<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>missionsUrl<span class="token punctuation">)</span><span class="token punctuation">;</span> 　　
    <span class="token keyword">const</span> missionDescription <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">getJSON</span><span class="token punctuation">(</span>missions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>detailsUrl<span class="token punctuation">)</span><span class="token punctuation">;</span> 　　 <span class="token comment">//对每个异步任务均执行yield 　　</span>
    <span class="token comment">//Study the mission details </span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span> 　　
    <span class="token comment">//Oh no, we weren't able to get the mission details 　</span>
    <span class="token punctuation">}</span>　<span class="token comment">//们依旧可以使用标准的语言结构，诸如try-catch语句或者循环语句 </span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token keyword">async</span><span class="token punctuation">(</span><span class="token parameter">generator</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>　<span class="token comment">//定义一个辅助函数，用于对我们定义的生成器执行操作 　</span>
    <span class="token keyword">var</span> iterator <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>　　<span class="token comment">//创建一个迭代器，进而我们可以控制生成器</span>
    <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token parameter">iteratorResult</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>　　<span class="token comment">//定义函数handle，用于对生成器产生的每个值进行处理 　　</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>iteratorResult<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>　<span class="token comment">//当生成器没有更多结果返回时停 止执行</span>
    　　<span class="token keyword">const</span> iteratorValue <span class="token operator">=</span> iteratorResult<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    　　<span class="token keyword">if</span><span class="token punctuation">(</span>iteratorValue <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 　　　
          iteratorValue<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token function">handle</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> iterator<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token comment">//如果生成的值是一个promise，则对其注册成功和失败回调。这是异步处理的部分。如果promise成功返回，</span>
           <span class="token comment">//则恢复生成器的执行并传入promise的返回结果。如果遇到错误，则向生成器抛出异常 　　</span>
       <span class="token punctuation">}</span> 　
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span> 　　
        <span class="token function">handle</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 　
    <span class="token punctuation">}</span> 　
    <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        iterator<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="async和await"><a href="#async和await" class="header-anchor">#</a> async和await</h2> <p>由于不直观和复杂，现在生成器用的已经很少了，取而代之的是其语法糖async和await，使用思想基本是一致的，只不过学习生成器更利于我们对新特性的理解，下篇文章再讲async和await。</p> <h2 id="参考书籍"><a href="#参考书籍" class="header-anchor">#</a> 参考书籍</h2> <p>《JS忍者秘籍第二版》</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/pages/Javascript/JS中的类型判断.html" class="prev">JS中的类型判断</a></span> <span class="next"><a href="/pages/Javascript/掘金小册《前端性能优化原理与实践》阅读总结.html">掘金小册《前端性能优化原理与实践》阅读总结.md</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8d8834a2.js" defer></script><script src="/assets/js/2.4111b689.js" defer></script><script src="/assets/js/11.06b0a1b9.js" defer></script>
  </body>
</html>
