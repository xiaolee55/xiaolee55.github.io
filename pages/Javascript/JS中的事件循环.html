<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JS中的事件循环（Event Loop） | XiaoLeeBlog</title>
    <meta name="description" content="我的文章网站">
    <link rel="icon" href="/titlelogo.png">
    
    <link rel="preload" href="/assets/css/0.styles.ec507139.css" as="style"><link rel="preload" href="/assets/js/app.8d8834a2.js" as="script"><link rel="preload" href="/assets/js/2.4111b689.js" as="script"><link rel="preload" href="/assets/js/7.331065bf.js" as="script"><link rel="prefetch" href="/assets/js/10.f5b7094d.js"><link rel="prefetch" href="/assets/js/11.06b0a1b9.js"><link rel="prefetch" href="/assets/js/12.a29a4b4d.js"><link rel="prefetch" href="/assets/js/13.85dd6f14.js"><link rel="prefetch" href="/assets/js/14.e058b9f1.js"><link rel="prefetch" href="/assets/js/15.fa0a1b7f.js"><link rel="prefetch" href="/assets/js/16.c674646e.js"><link rel="prefetch" href="/assets/js/3.f0f9c942.js"><link rel="prefetch" href="/assets/js/4.9eed5240.js"><link rel="prefetch" href="/assets/js/5.d37db87a.js"><link rel="prefetch" href="/assets/js/6.64a418b3.js"><link rel="prefetch" href="/assets/js/8.a14ac5eb.js"><link rel="prefetch" href="/assets/js/9.7e7c1c97.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ec507139.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/fe.png" alt="XiaoLeeBlog" class="logo"> <span class="site-name can-hide">XiaoLeeBlog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文章" class="dropdown-title"><span class="title">文章</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/Javascript/JS中的作用域与闭包.html" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/pages/HTML与CSS/BFC的理解与运用.html" class="nav-link">HTML与CSS</a></li></ul></div></div><div class="nav-item"><a href="/pages/folder1/test3.html" class="nav-link">我的项目</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="读书笔记" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/读书笔记/图解HTTP/http方法.html" class="nav-link">图解HTTP</a></li><li class="dropdown-item"><!----> <a href="/pages/读书笔记/图解HTTP/http方法.html" class="nav-link">JS忍者秘籍</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/xiaolee55" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文章" class="dropdown-title"><span class="title">文章</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/Javascript/JS中的作用域与闭包.html" class="nav-link">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/pages/HTML与CSS/BFC的理解与运用.html" class="nav-link">HTML与CSS</a></li></ul></div></div><div class="nav-item"><a href="/pages/folder1/test3.html" class="nav-link">我的项目</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="读书笔记" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/读书笔记/图解HTTP/http方法.html" class="nav-link">图解HTTP</a></li><li class="dropdown-item"><!----> <a href="/pages/读书笔记/图解HTTP/http方法.html" class="nav-link">JS忍者秘籍</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/xiaolee55" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>JavaScript基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/Javascript/JS中的作用域与闭包.html" class="sidebar-link">JS中的作用域与闭包</a></li><li><a href="/pages/Javascript/JS中的值传递.html" class="sidebar-link">JS中的值传递</a></li><li><a href="/pages/Javascript/JS中的事件循环.html" class="active sidebar-link">JS中的事件循环</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/Javascript/JS中的事件循环.html#事件循环是什么，为什么需要事件循环" class="sidebar-link">事件循环是什么，为什么需要事件循环</a></li><li class="sidebar-sub-header"><a href="/pages/Javascript/JS中的事件循环.html#为了理解事件循环，需要了解哪些相关概念" class="sidebar-link">为了理解事件循环，需要了解哪些相关概念</a></li><li class="sidebar-sub-header"><a href="/pages/Javascript/JS中的事件循环.html#细分宏任务（macro-task）和微任务（micro-task）" class="sidebar-link">细分宏任务（macro-task）和微任务（micro-task）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/Javascript/JS中的事件循环.html#宏任务微任务都有哪些" class="sidebar-link">宏任务微任务都有哪些</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/Javascript/JS中的事件循环.html#事件循环的完整过程" class="sidebar-link">事件循环的完整过程</a></li><li class="sidebar-sub-header"><a href="/pages/Javascript/JS中的事件循环.html#参考文章" class="sidebar-link">参考文章</a></li></ul></li><li><a href="/pages/Javascript/JS中的对象访问控制.html" class="sidebar-link">JS中的对象访问控制</a></li><li><a href="/pages/Javascript/JS中的类型判断.html" class="sidebar-link">JS中的类型判断</a></li><li><a href="/pages/Javascript/JS中的生成器和Promise.html" class="sidebar-link">JS中的生成器和Promise</a></li><li><a href="/pages/Javascript/掘金小册《前端性能优化原理与实践》阅读总结.html" class="sidebar-link">掘金小册《前端性能优化原理与实践》阅读总结.md</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="js中的事件循环（event-loop）"><a href="#js中的事件循环（event-loop）" class="header-anchor">#</a> JS中的事件循环（Event Loop）</h1> <h2 id="事件循环是什么，为什么需要事件循环"><a href="#事件循环是什么，为什么需要事件循环" class="header-anchor">#</a> 事件循环是什么，为什么需要事件循环</h2> <p>简单来书，Event Loop是js实现异步的一种方法，也是js的执行机制。众所周知JS是一门单线程的语言，所以本身只能执行同步代码，Event Loop就是为JS提供异步能力而生。至于JS为什么是单线程的，事出有因，想一下如果JS多线程，两个线程一个删除DOM，一个在同一个DOM上删除结点，那该以哪个为准？</p> <h2 id="为了理解事件循环，需要了解哪些相关概念"><a href="#为了理解事件循环，需要了解哪些相关概念" class="header-anchor">#</a> 为了理解事件循环，需要了解哪些相关概念</h2> <ul><li>任务（task）</li> <li>执行栈（run stack，也叫调用栈）</li> <li>主线程（main process）</li> <li>任务队列（task queue,有些文章也叫事件队列）</li> <li>事件表（Event Table）</li></ul> <p>上面这几个概念在下文会频繁使用，所以一个个介绍一下。
<img src="https://i.loli.net/2019/12/12/dEfpR7ujPZAJY2X.png" alt="image.png"><strong>（图片出处忘记了，图中的WebAPI可以理解为本文提到的事件表）</strong></p> <p><strong>任务</strong>：任务又分为同步任务和异步任务，每个任务进入执行栈之后会被引擎判断为同步任务OR异步任务，同步任务会被主线程立刻执行，异步任务则会被挂起至事件表，等待合适的时机进入任务队列并执行。</p> <p><strong>执行栈</strong>：每个任务都会放至执行栈中执行，我们都知道栈是一种先进后出的数据结构，所以在栈顶的任务会被先执行，执行结束则被弹出栈。</p> <p><strong>主线程</strong>：主线程首先会将同步任务执行完，再去读取任务队列中的队头，并将任务队列中的任务一一执行（执行一个任务的过程中不允许其他任务中断）。</p> <p><strong>任务队列</strong>：任务队列即是用于放置即将执行的异步任务的，任务又分为宏任务和微任务。队列是一种先进先出的数据结构，所以最早加入任务队列的异步任务也会被最早放在队首执行。</p> <p><strong>事件表</strong>：这个概念在很多文章会淡掉，导致我一度以为异步任务会直接进入任务队列，但实际不是这样的。JS引擎是单线程的，并不代表其执行环境也是单线程的（执行环境包括浏览器，node.js等），事实上浏览器包括多个进程，比如GUI线程（渲染UI），定时器线程（setTimeout。setInterval等），事件触发线程（如用户点击事件等），网络请求线程（如ajax等）。因为这些本身和事件循环关系不大，所以我们将他们统称为事件表，即我们可以理解为挂起的异步任务会存放在事件表中，等到合适的时机再从事件表加入任务队列等待执行（比如setTimeout有100ms延迟，这100ms内它就是存在于事件表的，100ms后再加入任务队列）。</p> <h2 id="细分宏任务（macro-task）和微任务（micro-task）"><a href="#细分宏任务（macro-task）和微任务（micro-task）" class="header-anchor">#</a> 细分宏任务（macro-task）和微任务（micro-task）</h2> <h3 id="宏任务微任务都有哪些"><a href="#宏任务微任务都有哪些" class="header-anchor">#</a> 宏任务微任务都有哪些</h3> <p><strong>宏任务</strong>：Script（即script标签内的整体代码），触发的事件（点击，键盘等），网络事件（收发HTTP请求等），定时器延时器，UI渲染等都属于宏任务。</p> <p><strong>微任务</strong>：Promise中的回调任务（then，catch），注意：new Promise()本身并不属于异步任务，更不会是微任务，只是他的回调任务才是微任务，下面会有例子讲解。除了这个，还有node中的process.nextTick也属于微任务</p> <p>既然分了宏任务和微任务，自然任务队列也就分为宏任务队列和微任务队列。</p> <blockquote><p><strong>在每次事件循环中都会执行一个宏任务，以及所有的微任务</strong>。</p></blockquote> <p>也就是说，一次循环，宏任务只允许执行一个，宏任务队列中的其他队列要等待微任务执行完成，而微任务队列中的所有任务都要执行完。每次执行完之后，浏览器可以选择是否重新渲染UI。</p> <h2 id="事件循环的完整过程"><a href="#事件循环的完整过程" class="header-anchor">#</a> 事件循环的完整过程</h2> <p>我们通过一份代码实例来剖析整个过程(代码例子来自https://juejin.im/post/59e85eebf265da430d571f89#comment)</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>，<span class="token number">100</span><span class="token punctuation">)</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'6'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'7'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'8'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'9'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'11'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'12'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>，<span class="token number">100</span><span class="token punctuation">)</span>
</code></pre></div><p>首先会从头开始执行整个JS代码，也就上面提到的宏任务中的“Script”，所以第一个毫无疑问会输出 <code>1</code>。</p> <table><thead><tr><th>run stack</th> <th>macro-task</th> <th>micro-task</th></tr></thead> <tbody><tr><td>Script</td> <td></td> <td></td></tr></tbody></table> <p>然后接着往下看，到了第一个<code>setimeOut</code>，识别为异步代码，则将其放入宏任务队列（实际上根据上面的介绍，我们知道它会先挂载至定时器线程，在事件列表中等待加入任务队列的时机（本例中是100ms后加入任务队列等待执行））。</p> <table><thead><tr><th>run stack</th> <th>macro-task</th> <th>micro-task</th></tr></thead> <tbody><tr><td>Script</td> <td>setTimeout</td> <td></td></tr></tbody></table> <p>接着继续往下执行到<code>process.nextTick()</code>，是微任务，则加入到微任务队列等待执行，继续往下执行到<code>new Promise()</code>，将里面的同步代码<code>console.log('7')</code>执行，并输出<code>7</code>而<code>then</code>中的代码则会放到微任务队列中。</p> <table><thead><tr><th>run stack</th> <th>macro-task</th> <th>micro-task</th></tr></thead> <tbody><tr><td>Script</td> <td>setTimeout</td> <td>process.nextTick(); then()</td></tr></tbody></table> <p>继续往下到第二个定时器，和第一个同理，挂起至定时器线程并等待时机加入任务队列。</p> <table><thead><tr><th>run stack</th> <th>macro-task</th> <th>micro-task</th></tr></thead> <tbody><tr><td>Script</td> <td>setTimeout ;setTimeout</td> <td>process.nextTick(); then()</td></tr></tbody></table> <p>至此为之，我们可以看到同步代码全部执行完成，事实上上面说的每一步都可以理解为同步任务，包括直接输出1，执行new Promise()，<strong>甚至将异步任务挂起这件事本身，也是一个同步任务</strong>。</p> <p>Script代码此时已执行完，接下来则应该进入微任务的执行，上面的步骤我们可以知道目前微任务队列中有两个任务，即<code>process.nextTick()</code>和<code>then</code>,按照上面所说的，微任务在一轮事件循环中要全部执行完，所以这里依次输出<code>6</code>,<code>8</code>，到此第一轮事件循环结束，控制台输出<code>1,7,6,8</code>。</p> <table><thead><tr><th>run stack</th> <th>macro-task</th> <th>micro-task</th></tr></thead> <tbody><tr><td>process.nextTick()</td> <td>setTimeout ;setTimeout</td> <td>then()</td></tr></tbody></table> <table><thead><tr><th>run stack</th> <th>macro-task</th> <th>micro-task</th></tr></thead> <tbody><tr><td>then()</td> <td>setTimeout ;setTimeout</td> <td></td></tr></tbody></table> <p>接下来主进程又会到宏任务队列的队首获取事件，即第一个定时器加入执行栈，里边代码按顺序执行，因此先输出<code>2</code>，<code>process.nextTick</code>放至微任务队列，<code>new Promise()</code>执行输出<code>4</code>，到此宏任务执行完，微任务依次进入执行栈，依次输出<code>3,5</code>，所以第二轮输出为<code>2,4,3,5</code>，本轮循环结束，进入下一轮循环。</p> <table><thead><tr><th>run stack</th> <th>macro-task</th> <th>micro-task</th></tr></thead> <tbody><tr><td>setTimeout</td> <td>setTimeout</td> <td>process.nextTick()</td></tr></tbody></table> <table><thead><tr><th>run stack</th> <th>macro-task</th> <th>micro-task</th></tr></thead> <tbody><tr><td>process.nextTick()</td> <td>setTimeout</td> <td></td></tr></tbody></table> <p>即进第二个定时器进入执行栈由主线程执行，过程和前两轮无异，依次输出<code>9,11,10,12</code></p> <table><thead><tr><th>run stack</th> <th>macro-task</th> <th>micro-task</th></tr></thead> <tbody><tr><td>setTimeout</td> <td></td> <td>then()</td></tr></tbody></table> <p>所以本例子的输出完整顺序为<code>1，7，6，8，2，4，3，5，9，11，10，12</code>，</p> <blockquote><p>注意：事件循环在不同环境的实现可能不同，本例子运行于Chrome50环境。</p></blockquote> <h2 id="参考文章"><a href="#参考文章" class="header-anchor">#</a> 参考文章</h2> <p>https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/
https://juejin.im/post/59e85eebf265da430d571f89#comment</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/pages/Javascript/JS中的值传递.html" class="prev">JS中的值传递</a></span> <span class="next"><a href="/pages/Javascript/JS中的对象访问控制.html">JS中的对象访问控制</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8d8834a2.js" defer></script><script src="/assets/js/2.4111b689.js" defer></script><script src="/assets/js/7.331065bf.js" defer></script>
  </body>
</html>
